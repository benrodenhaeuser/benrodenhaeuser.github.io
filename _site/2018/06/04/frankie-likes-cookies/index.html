<!doctype html>
<html lang="en-US">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <title>Ben Rodenhäuser | Notes on programming</title>

  <link href="https://fonts.googleapis.com/css?family=Lato|Anton|Roboto Mono" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/main.css?v=">
  <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    CommonHTML: { linebreaks: { automatic: true } },
    "HTML-CSS": { linebreaks: { automatic: true } },
           SVG: { linebreaks: { automatic: true } }
  });
  </script>
  <script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML&delayStartupUntilConfig">
  </script>
  <script src="/assets/jax/config.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!--[if lt IE 9]>
  <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-99334571-1', 'auto');
        ga('send', 'pageview');
    </script>
  
</head>

  <body>
    <div class="wrapper">
      <section>
  <p>
    <small>
      04 June 2018
    </small>
  </p>

  <h1 class="title">
    Frankie Likes Cookies
  </h1>

  <div class="description">
    Working with Rack middleware: part 04 of the "Sinatra From Scratch" series.
  </div>

  <div class="content">
    <hr class="line" />
    <div class="content-inner">
      <blockquote class="aside">
  <p>This is the final part in a four part series of blog posts that starts <a href="/2018/06/01/sinatra-from-scratch/">here</a>.</p>
</blockquote>

<p>The <a href="/2018/06/03/frankie-sees-a-pattern/">previous part</a> of this series of blog posts on Sinatra internals dealt with route parameters. In this final part, we turn to Sinatra’s take on Rack middleware, and briefly discuss those aspects of Frankie that are <em>not</em> covered in detail in the series.</p>

<p>The concept of Rack middleware grows naturally out of the concept of a Rack application. As described in <a href="http://notes.benrodenhaeuser.io/2018/06/01/sinatra-from-scratch/">part 01</a>, a Rack application is an object that responds to <code class="highlighter-rouge">call</code> and returns a three-element array of the appropriate kind. Now nothing prevents a Rack app from sending a <code class="highlighter-rouge">call</code> message to <em>another</em> Rack app, and using the return value of that <code class="highlighter-rouge">call</code> to determine its own return value. If a number of Rack apps are hooked up in this way, each calling the next, the non-terminal nodes in this configuration are <em>middleware</em> (think of the middleware chain as a linked list of Rack apps and you are not far off from the truth). We can then wrap the whole chain in <em>another</em> object that responds to <code class="highlighter-rouge">call</code> (and returns an appropriate array) and provides an entry point to the whole middleware chain.</p>

<p>Sinatra applications are Rack applications, so of course they place nice with Rack middleware. If you have a number of middleware nodes you want to make use of, all you need to do is place corresponding <code class="highlighter-rouge">use</code> statements close to the top of your Sinatra application file, such as:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="n">use</span> <span class="no">MyMiddleware1</span>
<span class="n">use</span> <span class="no">MyMiddleware2</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Sinatra will hook up the nodes in such way that, as a new request comes in, a <code class="highlighter-rouge">MyMiddleware1</code> instance will be the first node to receive a <code class="highlighter-rouge">call</code> message, and an instance of <code class="highlighter-rouge">Sinatra::Application</code> will be the last (the Sinatra app <em>fronts</em> the middleware chain), with each but the last node <code class="highlighter-rouge">call</code>ing the next node in turn. This is simply the way Rack does it, and Sinatra sticks to the protocol.</p>

<p>In this section, we will implement the same functionality in Frankie, using cookie-based session management as provided by <code class="highlighter-rouge">Rack::Session::Cookie</code> as an example for a commonly used piece of middleware we can simply take off the shelf. As we will see, the presence of middleware will necessitate a more sophisticated way of handling the division of labour between class and instance that we first talked about in <a href="/2018/06/01/sinatra-from-scratch/">part 01</a> of this series.</p>

<blockquote class="aside">
  <p><code class="highlighter-rouge">Rack::Session::Cookie</code>  is also the default session management solution used by Sinatra. However, Sinatra goes one step further and makes sessions a setting, so beside <code class="highlighter-rouge">use Rack:Session::Cookies</code>, you can also simply do <code class="highlighter-rouge">enable :sessions</code>.</p>
</blockquote>

<p>First, let’s look at how to set up the middleware chain. The entry point to the middleware chain is stored in an instance variable <code class="highlighter-rouge">@prototype</code> (the choice of name will become clear in a minute). Setting up the <code class="highlighter-rouge">@protoype</code> object makes use of the middleware-handling capabilities already provided by Rack:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">Application</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
	<span class="k">def</span> <span class="nf">prototype</span>
	  <span class="vi">@prototype</span> <span class="o">||=</span> <span class="kp">new</span>
    <span class="k">end</span>

    <span class="k">alias</span> <span class="kp">new</span><span class="o">!</span> <span class="kp">new</span>

    <span class="k">def</span> <span class="nf">new</span>
      <span class="n">instance</span> <span class="o">=</span> <span class="kp">new</span><span class="o">!</span>
      <span class="n">build</span><span class="p">(</span><span class="n">instance</span><span class="p">).</span><span class="nf">to_app</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
      <span class="n">builder</span> <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Builder</span><span class="p">.</span><span class="nf">new</span>

      <span class="k">if</span> <span class="vi">@middleware</span>
        <span class="vi">@middleware</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">middleware</span><span class="p">,</span> <span class="n">args</span><span class="o">|</span>
          <span class="n">builder</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="n">middleware</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">builder</span><span class="p">.</span><span class="nf">run</span> <span class="n">app</span>
      <span class="n">builder</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">use</span><span class="p">(</span><span class="n">middleware</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
      <span class="p">(</span><span class="vi">@middleware</span> <span class="o">||=</span> <span class="p">[])</span> <span class="o">&lt;&lt;</span> <span class="p">[</span><span class="n">middleware</span><span class="p">,</span> <span class="n">args</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>The gist is this: every <code class="highlighter-rouge">use</code> statement in our code adds a middleware node to the <code class="highlighter-rouge">@middleware</code> array (for this to work, we need to <em>delegate</em> <code class="highlighter-rouge">use</code> statements from <code class="highlighter-rouge">main</code> to <code class="highlighter-rouge">Frankie::Application</code>, as described in <a href="/2018/06/01/sinatra-from-scratch/">part 01</a>). As a <code class="highlighter-rouge">@prototype</code> object is newly created (making use of the <code class="highlighter-rouge">Rack::Builder</code> class), all those nodes are „wired up“, with a <code class="highlighter-rouge">Frankie::Application</code> instance fronting the middleware chain. Note that the <code class="highlighter-rouge">@prototype</code> object is created only once and stored in the <code class="highlighter-rouge">@prototype</code> class instance variable. The next time around, <code class="highlighter-rouge">protoype</code> will return the value of that variable, rather than setting up the middleware chain again.</p>

<p>While this is clearly the right approach, it points to a problem for our earlier way of creating a new instance of <code class="highlighter-rouge">Frankie::Application</code> on every incoming request. Namely, once the middleware chain is set up as above, a specific instance of <code class="highlighter-rouge">Frankie::Application</code> will persistently front the middleware chain, i.e., it will survive across requests. After all, it’s stored as part of the middleware configuration in the <code class="highlighter-rouge">prototype</code> object. The question then is how to reinstate the „one instance per request“ principle in this context.</p>

<p>Sinatra’s, and accordingly, Frankie’s, solution is to use the stored instance as a blueprint which is duplicated with every request (hence the choice of the name „<code class="highlighter-rouge">prototype</code>“). So we add the following code:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">Application</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
      <span class="n">prototype</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="nb">dup</span><span class="p">.</span><span class="nf">call!</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">call!</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="c1"># routing code that used to live in `call` goes here</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>As the <code class="highlighter-rouge">Frankie::Application</code> <em>class</em> receives a <code class="highlighter-rouge">call</code> from the web server, it passes the <code class="highlighter-rouge">call</code> to the <code class="highlighter-rouge">prototype</code> object. This results in the middleware nodes being <code class="highlighter-rouge">call</code>ed in turn, until finally, the <code class="highlighter-rouge">Frankie::Application</code> instance fronting the chain is <code class="highlighter-rouge">call</code>ed. At this point, the instance <em>duplicates itself</em> and invokes <code class="highlighter-rouge">call!</code> on the duplicate. The actual route-handling code that used to live in <code class="highlighter-rouge">Frankie::Application#call</code> is simply moved to <code class="highlighter-rouge">call!</code>. Overall, this is really elegant, and it’s just how Sinatra does it.</p>

<p>As promised, setting up middleware is really easy now. For illustration, return to our use case of cookie-based session management. Let’s first add a <code class="highlighter-rouge">session</code> method for accessing the session object. It simply wraps the session object provided by Rack:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="k">module</span>
  <span class="nn">class</span> <span class="no">Application</span>
    <span class="k">def</span> <span class="nf">session</span>
      <span class="vi">@request</span><span class="p">.</span><span class="nf">session</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Now all we really need to do as a Frankie user is to add the earlier-mentioned use statement to our app:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Session</span><span class="o">::</span><span class="no">Cookie</span><span class="p">,</span> <span class="ss">:key</span> <span class="o">=&gt;</span> <span class="s1">'rack.session'</span><span class="p">,</span> <span class="ss">:secret</span> <span class="o">=&gt;</span> <span class="s2">"secret"</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>To verify that our session management works, we send ourselves a message across requests:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12</pre></td><td class="code"><pre><span class="n">get</span> <span class="s1">'/set_message'</span> <span class="k">do</span>
  <span class="n">session</span><span class="p">[</span><span class="ss">:message</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Hello, there."</span>
  <span class="s2">"Message has been set."</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/get_message'</span> <span class="k">do</span>
  <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="ss">:message</span><span class="p">]</span>
	<span class="s2">"Your message: "</span> <span class="o">+</span> <span class="n">session</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="ss">:message</span><span class="p">)</span>
  <span class="k">else</span>
	<span class="s2">"There is no message."</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Use <a href="https://github.com/benrodenhaeuser/frankie/blob/master/iterations/04_frankie_likes_cookies/frankie.rb">this file</a> (which provides a snapshot of the state of Frankie after these four posts) to see for yourself, if you like. So now we have a version of Frankie that can handle cookies, as well as other pieces of middleware that may come in handy. Neat!</p>

<p>This completes our small tour of Sinatra functionality rebuilt from scratch. See the box below for pointers to some additional features that I have not discussed in detail. You might also want to check out the Frankie sample app mentioned in <a href="http://localhost:4000/2018/06/01/sinatra-from-scratch/">part 01</a>, if only to conclude that it really does look like a Sinatra app. You can find all the material in the Frankie repo <a href="https://github.com/benrodenhaeuser/frankie">on Github</a>.</p>

<blockquote class="aside">
  <h3 id="theres-more">There’s More</h3>
  <p>As mentioned earlier, there is more to Frankie than I could cover in this series of posts. Here is a quick overview of what Sinatra-inspired features you will find in the <a href="https://github.com/benrodenhaeuser/frankie/blob/master/frankie.rb">complete Frankie source</a> beyond what we discussed here:</p>
  <ul>
    <li>View templates: to better organize your code, separate presentation from application logic with view templates. The bindings of the application instance are passed into the template so that instance variables remain useable. An additional <a href="https://github.com/benrodenhaeuser/frankie/blob/459a2a2997b8fd96d2af5617665eed53cbe7a4a6/frankie.rb#L4"><code class="highlighter-rouge">Templates</code> module</a> does the job.</li>
    <li>Throw/catch: Sinatra makes quite heavy use of the <code class="highlighter-rouge">throw</code>/<code class="highlighter-rouge">catch</code> mechanism when handling requests. This is what makes Sinatra’s <code class="highlighter-rouge">halt</code> possible, praised in <a href="http://myronmars.to/n/dev-blog/2012/01/why-sinatras-halt-is-awesome">this post</a>. To see how this is implemented in Frankie, start at the  <code class="highlighter-rouge">invoke { dispatch! }</code> method call <a href="https://github.com/benrodenhaeuser/frankie/blob/459a2a2997b8fd96d2af5617665eed53cbe7a4a6/frankie.rb#L114">here</a>.</li>
    <li>Flexible return values: Frankie allows return values of route blocks to be strings (that end up as the response body), numbers (status codes) or Rack-compliant arrays. The code that allows for this flexibility is <a href="https://github.com/benrodenhaeuser/frankie/blob/459a2a2997b8fd96d2af5617665eed53cbe7a4a6/frankie.rb#L139">part of the <code class="highlighter-rouge">invoke</code> method</a>.</li>
    <li>Launching your application: the way Sinatra is set up, you simply <code class="highlighter-rouge">require 'sinatra'</code> at the top of an <code class="highlighter-rouge">app.rb</code> file, write your routes, and launch the app with <code class="highlighter-rouge">ruby app.rb</code> (at least if you code in the so-called „classical style“). To make this possible, Sinatra uses the <a href="https://blog.arkency.com/2013/06/are-we-abusing-at-exit/"><code class="highlighter-rouge">at_exit</code> trick</a>, and so does Frankie.</li>
  </ul>
</blockquote>


    </div>
  </div>

  <p class='terminal'>
    <small>&nbsp;</small>
  </p>
  <hr class="line" />
</section>

      <header>
  <p>
    <small>&nbsp;</small>
  </p>
  <a href="http://notes.benrodenhaeuser.io">
    <h1 class="title">
      Ben Rodenhäuser
    </h1>
  </a>

  <div class="description site-description">
    Notes on programming
  </div>

  <div class="content">
    <hr class="line" />

    <div class="sidebar-content">
      
      <h5>
        <a class="post-link" href="/2018/06/04/frankie-likes-cookies/">Frankie Likes Cookies</a><span class="sidebar-pad"></span><small>06/04/18</small>
      </h5>
      <p class="sidebar">
          Working with Rack middleware: part 04 of the "Sinatra From Scratch" series.
      </p>
      
      <h5>
        <a class="post-link" href="/2018/06/03/frankie-sees-a-pattern/">Frankie Sees a Pattern</a><span class="sidebar-pad"></span><small>06/03/18</small>
      </h5>
      <p class="sidebar">
          Defining parametrized routes: part 03 of the "Sinatra From Scratch" series.
      </p>
      
      <h5>
        <a class="post-link" href="/2018/06/02/frankie-reaches-for-the-top/">Frankie Reaches for the Top</a><span class="sidebar-pad"></span><small>06/02/18</small>
      </h5>
      <p class="sidebar">
          The top-level DSL: part 02 of the "Sinatra From Scratch" series.
      </p>
      
      <h5>
        <a class="post-link" href="/2018/06/01/sinatra-from-scratch/">Sinatra From Scratch</a><span class="sidebar-pad"></span><small>06/01/18</small>
      </h5>
      <p class="sidebar">
          Building a toy version of a Ruby web framework from the ground up.
      </p>
      
      <h5>
        <a class="post-link" href="/2017/12/20/operations-on-sets/">Operations on Sets</a><span class="sidebar-pad"></span><small>12/20/17</small>
      </h5>
      <p class="sidebar">
          Part 03 of the "Bunch of Sets" series.
      </p>
      
      <h5>
        <a class="post-link" href="/2017/12/19/modeling-sets/">Modeling Sets</a><span class="sidebar-pad"></span><small>12/19/17</small>
      </h5>
      <p class="sidebar">
          Part 02 of the "Bunch of Sets" series.
      </p>
      
      <h5>
        <a class="post-link" href="/2017/12/18/a-bunch-of-sets/">A Bunch of Sets</a><span class="sidebar-pad"></span><small>12/18/17</small>
      </h5>
      <p class="sidebar">
          A generic implementation of classical sets, multisets and fuzzy sets in Ruby.
      </p>
      
      <h5>
        <a class="post-link" href="/2017/07/06/object-passing/">Passing Objects</a><span class="sidebar-pad"></span><small>07/06/17</small>
      </h5>
      <p class="sidebar">
          Pass by reference or pass by value? The object passing strategy followed by Ruby.
      </p>
      
      <h5>
        <a class="post-link" href="/2017/05/15/sorting-in-ruby/">Sorting in Ruby</a><span class="sidebar-pad"></span><small>05/15/17</small>
      </h5>
      <p class="sidebar">
          Why does Ruby have two sorting methods, rather than one?
      </p>
      
    </div>

    <hr class="line" />

    <div class="external">
      <a href="http://github.com/benrodenhaeuser">
        <img class="mark" src="/assets/images/GitHub-Mark-64px.png" />
      </a>
    </div>
  </div>
</header>

      <!-- <footer>
  <p><small>Ben Rodenhäuser 2017 | <a href="http://github.com/benrodenhaeuser">GitHub Profile</a></small></p>
</footer> -->

    </div>
    <script src="/assets/js/scale.fix.js"></script>
  </body>
</html>
  

