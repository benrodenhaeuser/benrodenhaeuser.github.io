<!doctype html>
<html lang="en-US">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <title>Ben Rodenhäuser | Notes on programming</title>

  <link href="https://fonts.googleapis.com/css?family=Lato|Anton|Roboto Mono" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/main.css?v=">
  <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    CommonHTML: { linebreaks: { automatic: true } },
    "HTML-CSS": { linebreaks: { automatic: true } },
           SVG: { linebreaks: { automatic: true } }
  });
  </script>
  <script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML&delayStartupUntilConfig">
  </script>
  <script src="/assets/jax/config.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!--[if lt IE 9]>
  <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-99334571-1', 'auto');
        ga('send', 'pageview');
    </script>
  
</head>

  <body>
    <div class="wrapper">
      <section>
  <p>
    <small>
      02 June 2018
    </small>
  </p>

  <h1 class="title">
    Frankie Goes Top Level
  </h1>

  <div class="description">
    The top-level DSL: part 02 of the "Understanding Sinatra" series.
  </div>

  <div class="content">
    <hr class="line" />
    <div class="content-inner">
      <blockquote class="aside">
  <p>This is part 02 in a four part series of blog posts that starts <a href="/2018/06/01/understanding-sinatra/">here</a>.</p>
</blockquote>

<p>In <a href="/2018/06/01/understanding-sinatra/">part 01</a> of this series, we reproduced the basic division of labour between class and instance that is a core aspect of Sinatra, and set up mechanisms for route storage and request handling that implement this division of labour. Next, we turn to some aspects of the top-level DSL for which Sinatra is often praised.</p>

<p>To get a Sinatra application going, all you really need to do is <code class="highlighter-rouge">require 'sinatra'</code> at the top of your file, and go forth writing routes like the following:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="n">get</span> <span class="s1">'/ditty'</span> <span class="k">do</span>
  <span class="n">status</span> <span class="mi">301</span>
  <span class="s1">'Go look elsewhere'</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>While it’s obvious for any Rubyist that what we see here is actually a method invocation, the code is still quite mysterious. First, the <code class="highlighter-rouge">get</code> method is available at the top level of our program. How so? Second, the <code class="highlighter-rouge">status</code> method – which sets the status code of our HTTP response – is in scope within the route block. Why is that? You may remember methods with these names from the previous part of the series. Still, the question remains why they would be available here.</p>

<p>The answers to the two questions go something like this: As for (1), Sinatra <em>delegates</em> certain method calls – like <code class="highlighter-rouge">get</code> invocations, for instance – from the top level to the <code class="highlighter-rouge">Application</code> class. And as for (2), the block that is passed with the <code class="highlighter-rouge">get</code> invocation will eventually be evaluated <em>in the context of the instance</em> handling the request, rather than in the context provided by top-level <code class="highlighter-rouge">main</code>.</p>

<p>Let’s  see how to implement this in Frankie, our toy version of Sinatra. First, to be able to delegate top level method calls, we add another module to <code class="highlighter-rouge">Frankie</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14</pre></td><td class="code"><pre><span class="k">module</span> <span class="nn">Frankie</span>
  <span class="k">module</span> <span class="nn">Delegator</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">delegate</span><span class="p">(</span><span class="n">method_name</span><span class="p">)</span>
      <span class="n">define_method</span><span class="p">(</span><span class="n">method_name</span><span class="p">)</span> <span class="k">do</span> <span class="o">|*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="o">|</span>
        <span class="no">Application</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">method_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">delegate</span><span class="p">(</span><span class="ss">:get</span><span class="p">)</span>
    <span class="n">delegate</span><span class="p">(</span><span class="ss">:post</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="kp">extend</span> <span class="no">Frankie</span><span class="o">::</span><span class="no">Delegator</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>As a result of this code, any <code class="highlighter-rouge">get</code> and <code class="highlighter-rouge">post</code> invocations received by <code class="highlighter-rouge">main</code> will be passed on  to the <code class="highlighter-rouge">Application</code> object. Take note that the last line of the snippet lives at the top level. Also, it reads <code class="highlighter-rouge">extend</code> rather than <code class="highlighter-rouge">include</code>. If we had used <code class="highlighter-rouge">include</code> instead, the newly defined methods would be added to <code class="highlighter-rouge">Object</code>. But <code class="highlighter-rouge">extend</code> merely attaches them to <code class="highlighter-rouge">main</code>. This takes care of our first issue: we can now freely invoke <code class="highlighter-rouge">get</code> (and <code class="highlighter-rouge">post</code>) from the top level, without having to prefix our routes with <code class="highlighter-rouge">Frankie::Application</code>.</p>

<p>Now what about method invocations <em>within</em> the route block, our second point above? The answer we give is, again, meta-programming, and more in particular: <code class="highlighter-rouge">instance_eval</code>. The documentation for this method (which belongs to <code class="highlighter-rouge">BasicObject</code> and is thus available to any Ruby object) tells us that <code class="highlighter-rouge">instance_eval</code> “evaluates (…) the given block (…) within the context of the receiver.” Now this is of course precisely what we need, since we want our route block to be evaluated in the context of the instance handling the current request.</p>

<blockquote class="aside">
  <p>While early versions of Sinatra made use of <code class="highlighter-rouge">instance_eval</code> in the way described in this post, later versions (including the current one) employ a different and slightly more involved mechanism. It involves generating method objects from given route blocks that are dynamically bound to the current instance as a request is processed. For details, consult <a href="https://github.com/sinatra/sinatra/blob/a1e36db87e9d6bc3a2d8721078da18e704ee8ba3/lib/sinatra/base.rb#L1614">the Sinatra source</a>.</p>
</blockquote>

<p>To put <code class="highlighter-rouge">instance_eval</code> to use, all we really need to change is one line of code – the last line of our <code class="highlighter-rouge">route!</code> method:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12</pre></td><td class="code"><pre><span class="k">module</span> <span class="nn">Frankie</span>
  <span class="k">class</span> <span class="nc">Application</span>
	<span class="k">def</span> <span class="nf">route!</span>
	  <span class="n">match</span> <span class="o">=</span> <span class="no">Application</span><span class="p">.</span><span class="nf">routes</span>
	                     <span class="p">.</span><span class="nf">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span> <span class="n">r</span><span class="p">[</span><span class="ss">:verb</span><span class="p">]</span> <span class="o">==</span> <span class="vi">@verb</span> <span class="p">}</span>
	                     <span class="p">.</span><span class="nf">find</span>   <span class="p">{</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span> <span class="n">r</span><span class="p">[</span><span class="ss">:path</span><span class="p">]</span> <span class="o">==</span> <span class="vi">@path</span> <span class="p">}</span>
	  <span class="k">return</span> <span class="n">status</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span> <span class="k">unless</span> <span class="n">match</span>

	  <span class="n">body</span> <span class="nb">instance_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">match</span><span class="p">[</span><span class="ss">:block</span><span class="p">])</span>
	<span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Recall that <code class="highlighter-rouge">match[:block]</code> is a Proc object. We convert it to a block <code class="highlighter-rouge">&amp;match[:block]</code>, and pass it into <code class="highlighter-rouge">instance_eval</code>. Since the receiver of the <code class="highlighter-rouge">instance_eval</code> message is our <code class="highlighter-rouge">Frankie::Application</code> instance, this instance provides the context in which the block is evaluated. So in particular, all the instance methods of <code class="highlighter-rouge">Frankie::Application</code> are available.</p>

<p>Summing up, two main ingredients enable top-level route controlers: delegated method calls, and route blocks that are re-scoped to the current application instance as a request is handled. Run <a href="https://github.com/benrodenhaeuser/frankie/blob/master/iterations/02_frankie_goes_top_level/frankie.rb">this file</a> (our code so far), head to <code class="highlighter-rouge">localhost:8080/ditty</code>, and you will see that our sample request from above works: we get back a 301, and are told to “go look elsewhere”.</p>

<p>Fair enough. Let’s move on <a href="/2018/06/03/frankie-recognizes-patterns/">to the next part of the series</a>, where we talk about route parameters.</p>


    </div>
  </div>

  <p class='terminal'>
    <small>&nbsp;</small>
  </p>
  <hr class="line" />
</section>

      <header>
  <p>
    <small>&nbsp;</small>
  </p>
  <a href="http://notes.benrodenhaeuser.io">
    <h1 class="title">
      Ben Rodenhäuser
    </h1>
  </a>

  <div class="description site-description">
    Notes on programming
  </div>

  <div class="content">
    <hr class="line" />

    <div class="sidebar-content">
      
      <h5>
        <a class="post-link" href="/2018/06/04/frankie-likes-cookies/">Frankie Likes Cookies</a><span class="sidebar-pad"></span><small>06/04/18</small>
      </h5>
      <p class="sidebar">
          Working with Rack middleware: part 04 of the "Understanding Sinatra" series.
      </p>
      
      <h5>
        <a class="post-link" href="/2018/06/03/frankie-recognizes-patterns/">Frankie Recognizes Patterns</a><span class="sidebar-pad"></span><small>06/03/18</small>
      </h5>
      <p class="sidebar">
          Defining parametrized routes: part 03 of the "Understanding Sinatra" series.
      </p>
      
      <h5>
        <a class="post-link" href="/2018/06/02/frankie-goes-top-level/">Frankie Goes Top Level</a><span class="sidebar-pad"></span><small>06/02/18</small>
      </h5>
      <p class="sidebar">
          The top-level DSL: part 02 of the "Understanding Sinatra" series.
      </p>
      
      <h5>
        <a class="post-link" href="/2018/06/01/understanding-sinatra/">Understanding Sinatra</a><span class="sidebar-pad"></span><small>06/01/18</small>
      </h5>
      <p class="sidebar">
          Hello Frankie: building a toy version of a Ruby web framework from the ground up.
      </p>
      
      <h5>
        <a class="post-link" href="/2017/12/20/operations-on-sets/">Operations on Sets</a><span class="sidebar-pad"></span><small>12/20/17</small>
      </h5>
      <p class="sidebar">
          Part 03 of the "Bunch of Sets" series.
      </p>
      
      <h5>
        <a class="post-link" href="/2017/12/19/modeling-sets/">Modeling Sets</a><span class="sidebar-pad"></span><small>12/19/17</small>
      </h5>
      <p class="sidebar">
          Part 02 of the "Bunch of Sets" series.
      </p>
      
      <h5>
        <a class="post-link" href="/2017/12/18/a-bunch-of-sets/">A Bunch of Sets</a><span class="sidebar-pad"></span><small>12/18/17</small>
      </h5>
      <p class="sidebar">
          A generic implementation of classical sets, multisets and fuzzy sets in Ruby.
      </p>
      
      <h5>
        <a class="post-link" href="/2017/07/06/object-passing/">Passing Objects</a><span class="sidebar-pad"></span><small>07/06/17</small>
      </h5>
      <p class="sidebar">
          Pass by reference or pass by value? The object passing strategy followed by Ruby.
      </p>
      
      <h5>
        <a class="post-link" href="/2017/05/15/sorting-in-ruby/">Sorting in Ruby</a><span class="sidebar-pad"></span><small>05/15/17</small>
      </h5>
      <p class="sidebar">
          Why does Ruby have two sorting methods, rather than one?
      </p>
      
    </div>

    <hr class="line" />

    <div class="external">
      <a href="http://github.com/benrodenhaeuser">
        <img class="mark" src="/assets/images/GitHub-Mark-64px.png" />
      </a>
    </div>
  </div>
</header>

      <!-- <footer>
  <p><small>Ben Rodenhäuser 2017 | <a href="http://github.com/benrodenhaeuser">GitHub Profile</a></small></p>
</footer> -->

    </div>
    <script src="/assets/js/scale.fix.js"></script>
  </body>
</html>
  

