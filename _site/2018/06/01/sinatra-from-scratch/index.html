<!doctype html>
<html lang="en-US">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <title>Ben Rodenhäuser | Notes on programming</title>

  <link href="https://fonts.googleapis.com/css?family=Lato|Anton|Roboto Mono" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/main.css?v=">
  <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    CommonHTML: { linebreaks: { automatic: true } },
    "HTML-CSS": { linebreaks: { automatic: true } },
           SVG: { linebreaks: { automatic: true } }
  });
  </script>
  <script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML&delayStartupUntilConfig">
  </script>
  <script src="/assets/jax/config.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!--[if lt IE 9]>
  <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-99334571-1', 'auto');
        ga('send', 'pageview');
    </script>
  
</head>

  <body>
    <div class="wrapper">
      <section>
  <p>
    <small>
      01 June 2018
    </small>
  </p>

  <h1 class="title">
    Sinatra From Scratch
  </h1>

  <div class="description">
    Building a toy version of a Ruby web framework from the ground up.
  </div>

  <div class="content">
    <hr class="line" />
    <div class="content-inner">
      <p>This series of posts grew out of my own attempt to understand the inner workings of <a href="http://sinatrarb.com">Sinatra</a>, a popular Ruby tool for quickly building web applications. The Sinatra code base is comparatively compact, but dense. I found it quite challenging to read initially. My hope is that this series could be of help for people who would like to get a better understanding of Sinatra internals, just as I did when I started diving into its source code.</p>

<p>Rather than picking parts of the Sinatra source and commenting on them, I will present „Frankie“, a toy version of Sinatra I built to aid my own learning process. When I say „toy version of Sinatra“, I really mean four things: Frankie …</p>

<ol>
  <li>is fully functional,</li>
  <li>is not meant for real-world use,</li>
  <li>follows the way Sinatra does things very closely, and</li>
  <li>implements a <em>selection</em> of the Sinatra feature set only.</li>
</ol>

<p>In this post, we start even smaller: our initial version of Frankie will only run a couple dozen lines of code, and won’t be very capable at all. Subsequent iterations will extend and refine this base setting. Here is what we will be covering:</p>

<ul>
  <li>Storing routes and handling requests (this post)</li>
  <li>The top-level DSL (<a href="/2018/06/02/frankie-reaches-for-the-top/">part 02</a> of the series)</li>
  <li>Route parameters (<a href="/2018/06/03/frankie-recognizes-patterns/">part 03</a>)</li>
  <li>Rack middleware (<a href="/2018/06/04/frankie-likes-cookies/">part 04</a>)</li>
</ul>

<p>On every topic listed above, I will discuss how to implement a pared down version of core Sinatra functionality. Beyond these posts, Frankie has some additional Sinatra-derived features that I will not discuss in detail (but see <a href="/2018/06/04/frankie-likes-cookies/">part 04</a> for some comments):</p>

<ul>
  <li>Separating logic from presentation with view templates</li>
  <li>Flexible return values for route blocks</li>
  <li>Flexible control flow using <code class="highlighter-rouge">throw</code>/<code class="highlighter-rouge">catch</code></li>
</ul>

<p>The overall result is around 200 lines of code that – hopefully – give a pretty good impression of the way Sinatra works, and which should – hopefully – be a lot easier to understand than <a href="https://github.com/sinatra/sinatra/blob/master/lib/sinatra/base.rb"><code class="highlighter-rouge">sinatra/base.rb</code></a>, which has slightly less than 2000 lines of code.</p>

<blockquote class="aside">
  <p>Besides following this series of posts, one approach I would invite you to take is to read the Frankie source code <a href="https://github.com/benrodenhaeuser/frankie">on Github</a>, and use that as a launchpad for subsequently diving into the Sinatra source itself.</p>
</blockquote>

<h2 id="hello-frankie">Hello Frankie</h2>

<p>The people behind Sinatra like to emphasize that Sinatra is not a framework, but rather a tool for „solving HTTP“, a „DSL for quickly creating web applications in Ruby with minimal effort“.</p>

<p>While I will continue to use the term „framework“ (for lack of a better word, not to make some kind of point), the idea of „solving HTTP“ provides as good a starting point as any for our exploration. The most basic aspect of this is arguably the capability to set up route controlers that handle incoming HTTP requests. Sinatra sets up a basic division of labour in this regard: while routes are stored on the class level, requests are handled on the level of the instance.</p>

<p>To get started with our Frankie toy framework, let’s first see how to store routes.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></td><td class="code"><pre><span class="k">module</span> <span class="nn">Frankie</span>
  <span class="k">class</span> <span class="nc">Application</span>
    <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
      <span class="k">def</span> <span class="nf">routes</span>
        <span class="vi">@routes</span> <span class="o">||=</span> <span class="p">[]</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
        <span class="n">route</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
        <span class="n">route</span><span class="p">(</span><span class="s1">'POST'</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">route</span><span class="p">(</span><span class="n">verb</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
        <span class="n">routes</span> <span class="o">&lt;&lt;</span> <span class="p">{</span>
          <span class="ss">verb:  </span><span class="n">verb</span><span class="p">,</span>
          <span class="ss">path:  </span><span class="n">path</span><span class="p">,</span>
          <span class="ss">block: </span><span class="n">block</span>
        <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>It’s quite straightforward, really: a class instance variable <code class="highlighter-rouge">@routes</code> (accessible via the class method <code class="highlighter-rouge">Frankie::Application.routes</code>) is maintained that holds an array of routes. In our implementation, each route is a hash with three keys, <code class="highlighter-rouge">:verb</code>, <code class="highlighter-rouge">:path</code>, and <code class="highlighter-rouge">:block</code>. Requests will be matched against this array of route.</p>

<p>Running the following sample code against the above class definition:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="no">Frankie</span><span class="o">::</span><span class="no">Application</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="s2">"Frankie says hello."</span> <span class="p">}</span>
<span class="nb">puts</span> <span class="no">Frankie</span><span class="o">::</span><span class="no">Application</span><span class="p">.</span><span class="nf">routes</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>… you should see something similar to this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="p">{</span>
  <span class="ss">:verb</span> <span class="o">=&gt;</span> <span class="s2">"GET"</span><span class="p">,</span>
  <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s2">"/"</span><span class="p">,</span>
  <span class="ss">:block</span> <span class="o">=&gt;</span> <span class="c1">#&lt;Proc:0x007faa7b03f458@frankie.rb:36&gt;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>That’s all there is to it at this point: a route, ready to be requested. If the <code class="highlighter-rouge">:verb</code> for a given request is <code class="highlighter-rouge">GET</code>, and its <code class="highlighter-rouge">:path</code> is <code class="highlighter-rouge">'/'</code>, then you can imagine that the value for  the <code class="highlighter-rouge">:block</code> key (a <code class="highlighter-rouge">Proc</code> object) holds the code that will determine how to handle that request. Let’s implement this idea.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44</pre></td><td class="code"><pre><span class="k">module</span> <span class="nn">Frankie</span>
  <span class="k">class</span> <span class="nc">Application</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
      <span class="kp">new</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
      <span class="vi">@request</span>  <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
      <span class="vi">@verb</span>     <span class="o">=</span> <span class="vi">@request</span><span class="p">.</span><span class="nf">request_method</span>
      <span class="vi">@path</span>     <span class="o">=</span> <span class="vi">@request</span><span class="p">.</span><span class="nf">path_info</span>

      <span class="vi">@response</span> <span class="o">=</span> <span class="p">{</span>
        <span class="ss">status:  </span><span class="mi">200</span><span class="p">,</span>
        <span class="ss">headers: </span><span class="n">headers</span><span class="p">,</span>
        <span class="ss">body:    </span><span class="p">[]</span>
      <span class="p">}</span>

      <span class="n">route!</span>

      <span class="vi">@response</span><span class="p">.</span><span class="nf">values</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
      <span class="vi">@response</span><span class="p">[</span><span class="ss">:status</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">headers</span>
      <span class="vi">@headers</span> <span class="o">||=</span> <span class="p">{</span> <span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'text/html'</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
      <span class="vi">@response</span><span class="p">[</span><span class="ss">:body</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">string</span><span class="p">]</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">route!</span>
      <span class="n">match</span> <span class="o">=</span> <span class="no">Application</span><span class="p">.</span><span class="nf">routes</span>
                         <span class="p">.</span><span class="nf">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">route</span><span class="o">|</span> <span class="n">route</span><span class="p">[</span><span class="ss">:verb</span><span class="p">]</span> <span class="o">==</span> <span class="vi">@verb</span> <span class="p">}</span>
                         <span class="p">.</span><span class="nf">find</span>   <span class="p">{</span> <span class="o">|</span><span class="n">route</span><span class="o">|</span> <span class="n">route</span><span class="p">[</span><span class="ss">:path</span><span class="p">]</span> <span class="o">==</span> <span class="vi">@path</span> <span class="p">}</span>
      <span class="k">return</span> <span class="n">status</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span> <span class="k">unless</span> <span class="n">match</span>

      <span class="n">body</span> <span class="n">match</span><span class="p">[</span><span class="ss">:block</span><span class="p">].</span><span class="nf">call</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>First, have a look at the class method <code class="highlighter-rouge">Frankie::Application.call</code>. Sinatra implements the <a href="https://rack.github.io">Rack interface</a>, and, of course, Frankie follows suit. This means (1) that  <code class="highlighter-rouge">Frankie::Application</code> responds to <code class="highlighter-rouge">call</code> in the first place, and  (2) that the class method <code class="highlighter-rouge">call</code> returns a three-element array <code class="highlighter-rouge">[status, headers, body]</code>. Rack does the heavy lifting of parsing the HTTP request into the <code class="highlighter-rouge">env</code> hash that is passed to <code class="highlighter-rouge">call</code>, and assembling a valid HTTP response from <code class="highlighter-rouge">call</code>’s return value.</p>

<p>In the above code, the <em>class</em> method <code class="highlighter-rouge">call</code> creates a new instance of <code class="highlighter-rouge">Frankie::Application</code>, and invokes the <em>instance</em> method <code class="highlighter-rouge">call</code> on that new instance, passing along <code class="highlighter-rouge">env</code>. Instance level <code class="highlighter-rouge">call</code> will do the work, and its return value will determine the return value of class level <code class="highlighter-rouge">call</code>.</p>

<p>The idea of generating a new instance for every request reflects the stateless nature of the HTTP protocol: if the class itself were to handle the request, information could easily leak across requests. It also puts the division of labour mentioned above into practice: handling the request is an instance-level responsibility, so the class simply forwards the <code class="highlighter-rouge">call</code> to such an instance.</p>

<p>The <code class="highlighter-rouge">route!</code> method (an instance method, not to be confused with the earlier class method <code class="highlighter-rouge">route</code>) which is invoked from the instance method<code class="highlighter-rouge">call</code> is really the heart of the matter. Given an incoming request, <code class="highlighter-rouge">route!</code> attempts to fetch a matching route from the <code class="highlighter-rouge">routes</code> array maintained by the class. If successful, the Proc object stored for that route is called. The return value of that call determines the body of our HTTP response. If, on the other hand, no matching route is found, we send a 404 response to the client.</p>

<p>To see this in action, let’s add <code class="highlighter-rouge">require 'rack'</code> to the top of the file, and the following code to the bottom:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="no">Frankie</span><span class="o">::</span><span class="no">Application</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="s2">"Frankie says hello."</span> <span class="p">}</span>
<span class="no">Rack</span><span class="o">::</span><span class="no">Handler</span><span class="o">::</span><span class="no">WEBrick</span><span class="p">.</span><span class="nf">run</span> <span class="no">Frankie</span><span class="o">::</span><span class="no">Application</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Run the code (the file is <a href="https://github.com/benrodenhaeuser/frankie/blob/master/iterations/01_hello_frankie/frankie.rb">here</a>), point your browser to <code class="highlighter-rouge">localhost:8080</code> (8080 is the port <a href="https://github.com/rack/rack/blob/42e48013dd1b6dbda990dfa3851856c199b0b1f9/lib/rack/handler/webrick.rb#L32">set by the <code class="highlighter-rouge">Rack::Handler::WEBrick.run</code> method</a>), and you will be greeted by Frankie.</p>

<p>So we got ourselves the beginnings of a web framework, or the beginnings of a „tool for solving HTTP“, if you prefer. But, of course, we are just getting started. In <a href="/2018/06/02/frankie-reaches-for-the-top/">part 02 of the series</a>, we will have a look at one of the signature features of Sinatra: it’s elegant top level DSL.</p>


    </div>
  </div>

  <p class='terminal'>
    <small>&nbsp;</small>
  </p>
  <hr class="line" />
</section>

      <header>
  <p>
    <small>&nbsp;</small>
  </p>
  <a href="http://notes.benrodenhaeuser.io">
    <h1 class="title">
      Ben Rodenhäuser
    </h1>
  </a>

  <div class="description site-description">
    Notes on programming
  </div>

  <div class="content">
    <hr class="line" />

    <div class="sidebar-content">
      
      <h5>
        <a class="post-link" href="/2018/06/04/frankie-likes-cookies/">Frankie Likes Cookies</a><span class="sidebar-pad"></span><small>06/04/18</small>
      </h5>
      <p class="sidebar">
          Working with Rack middleware: part 04 of the "Sinatra From Scratch" series.
      </p>
      
      <h5>
        <a class="post-link" href="/2018/06/03/frankie-recognizes-patterns/">Frankie Recognizes Patterns</a><span class="sidebar-pad"></span><small>06/03/18</small>
      </h5>
      <p class="sidebar">
          Defining parametrized routes: part 03 of the "Sinatra From Scratch" series.
      </p>
      
      <h5>
        <a class="post-link" href="/2018/06/02/frankie-reaches-for-the-top/">Frankie Reaches for the Top</a><span class="sidebar-pad"></span><small>06/02/18</small>
      </h5>
      <p class="sidebar">
          The top-level DSL: part 02 of the "Sinatra From Scratch" series.
      </p>
      
      <h5>
        <a class="post-link" href="/2018/06/01/sinatra-from-scratch/">Sinatra From Scratch</a><span class="sidebar-pad"></span><small>06/01/18</small>
      </h5>
      <p class="sidebar">
          Building a toy version of a Ruby web framework from the ground up.
      </p>
      
      <h5>
        <a class="post-link" href="/2017/12/20/operations-on-sets/">Operations on Sets</a><span class="sidebar-pad"></span><small>12/20/17</small>
      </h5>
      <p class="sidebar">
          Part 03 of the "Bunch of Sets" series.
      </p>
      
      <h5>
        <a class="post-link" href="/2017/12/19/modeling-sets/">Modeling Sets</a><span class="sidebar-pad"></span><small>12/19/17</small>
      </h5>
      <p class="sidebar">
          Part 02 of the "Bunch of Sets" series.
      </p>
      
      <h5>
        <a class="post-link" href="/2017/12/18/a-bunch-of-sets/">A Bunch of Sets</a><span class="sidebar-pad"></span><small>12/18/17</small>
      </h5>
      <p class="sidebar">
          A generic implementation of classical sets, multisets and fuzzy sets in Ruby.
      </p>
      
      <h5>
        <a class="post-link" href="/2017/07/06/object-passing/">Passing Objects</a><span class="sidebar-pad"></span><small>07/06/17</small>
      </h5>
      <p class="sidebar">
          Pass by reference or pass by value? The object passing strategy followed by Ruby.
      </p>
      
      <h5>
        <a class="post-link" href="/2017/05/15/sorting-in-ruby/">Sorting in Ruby</a><span class="sidebar-pad"></span><small>05/15/17</small>
      </h5>
      <p class="sidebar">
          Why does Ruby have two sorting methods, rather than one?
      </p>
      
    </div>

    <hr class="line" />

    <div class="external">
      <a href="http://github.com/benrodenhaeuser">
        <img class="mark" src="/assets/images/GitHub-Mark-64px.png" />
      </a>
    </div>
  </div>
</header>

      <!-- <footer>
  <p><small>Ben Rodenhäuser 2017 | <a href="http://github.com/benrodenhaeuser">GitHub Profile</a></small></p>
</footer> -->

    </div>
    <script src="/assets/js/scale.fix.js"></script>
  </body>
</html>
  

