
<!doctype html>
<html lang="en-US">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <title>Ben Rodenhäuser | Notes on programming</title>

  <link href="https://fonts.googleapis.com/css?family=Lato|Anton|Roboto+Mono" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/main.css?v=">
  <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    CommonHTML: { linebreaks: { automatic: true } },
    "HTML-CSS": { linebreaks: { automatic: true } },
           SVG: { linebreaks: { automatic: true } }
  });
  </script>
  <script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML&delayStartupUntilConfig">
  </script>
  <script src="/assets/jax/config.js"></script>

  <meta name="viewport" content="width=device-width">
  <!--[if lt IE 9]>
  <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-99334571-1', 'auto');
        ga('send', 'pageview');
    </script>
  
</head>

  <body>
    <div class="wrapper">
      <section>
  <p>
    <small>
      11 March 2018
    </small>
  </p>

  <h1 class="title">
    Understanding Sinatra
  </h1>

  <div class="description">
    Building a toy version of a popular Ruby framework from the ground up.
  </div>

  <div class="content">
    <hr class="line" />
    <div class="content-inner">
      <p>We are going to develop our toy version of Sinatra in a number of iterations, starting “tiny”, and building towards “small”. This corresponds to how I built Frankie, too, even though this blog post makes the process perhaps appear a little more orderly than it really was.</p>

<h2 id="hello-frankie">Hello Frankie</h2>

<p>At its core, Sinatra is (1) a mechanism for storing routes, and (2) a mechanism for handling requests based on the routes stored. So this is where we start.</p>

<p>If you investigate the Sinatra source code, you will see that part (1), route storage, is a class task, while part (2), request handling, happens at the instance level. Let’s first see how to store routes.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">Application</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">routes</span>
      <span class="vi">@routes</span> <span class="o">||=</span> <span class="p">[]</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="n">route</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="n">route</span><span class="p">(</span><span class="s1">'POST'</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">route</span><span class="p">(</span><span class="n">verb</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
      <span class="n">routes</span> <span class="o">&lt;&lt;</span> <span class="p">{</span>
        <span class="ss">verb:  </span><span class="n">verb</span><span class="p">,</span>
        <span class="ss">path:  </span><span class="n">path</span><span class="p">,</span>
        <span class="ss">block: </span><span class="n">block</span>
      <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Routes are stored in an array which we can access via the <code class="highlighter-rouge">routes</code> class method. Invoking the <code class="highlighter-rouge">get</code> and <code class="highlighter-rouge">post</code> method defined above leads to a route being stored. As you can see by inspecting the <code class="highlighter-rouge">route</code> method, a route has three components: an HTTP <code class="highlighter-rouge">verb</code>, a URL <code class="highlighter-rouge">path</code>, and a block (a Proc object, to be precise). If the <code class="highlighter-rouge">verb</code> for a given request is <code class="highlighter-rouge">GET</code>, and its <code class="highlighter-rouge">path</code> is <code class="highlighter-rouge">'/'</code>, then you can imagine that the block will determine how to handle that request.</p>

<p>Now, how are requests handled?</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">Application</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="kp">new</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="vi">@request</span>  <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="vi">@verb</span>     <span class="o">=</span> <span class="vi">@request</span><span class="p">.</span><span class="nf">request_method</span>
    <span class="vi">@path</span>     <span class="o">=</span> <span class="vi">@request</span><span class="p">.</span><span class="nf">path_info</span>

    <span class="vi">@response</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">status:  </span><span class="mi">200</span><span class="p">,</span>
      <span class="ss">headers: </span><span class="n">headers</span><span class="p">,</span>
      <span class="ss">body:    </span><span class="p">[]</span>
    <span class="p">}</span>

    <span class="n">route!</span>

    <span class="vi">@response</span><span class="p">.</span><span class="nf">values</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">params</span>
    <span class="vi">@request</span><span class="p">.</span><span class="nf">params</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="vi">@response</span><span class="p">[</span><span class="ss">:status</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">headers</span>
    <span class="vi">@headers</span> <span class="o">||=</span> <span class="p">{</span> <span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'text/html'</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="vi">@response</span><span class="p">[</span><span class="ss">:body</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">string</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">route!</span>
    <span class="n">match</span> <span class="o">=</span> <span class="no">Application</span><span class="p">.</span><span class="nf">routes</span>
                       <span class="p">.</span><span class="nf">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">route</span><span class="o">|</span> <span class="n">route</span><span class="p">[</span><span class="ss">:verb</span><span class="p">]</span> <span class="o">==</span> <span class="vi">@verb</span> <span class="p">}</span>
                       <span class="p">.</span><span class="nf">find</span>   <span class="p">{</span> <span class="o">|</span><span class="n">route</span><span class="o">|</span> <span class="n">route</span><span class="p">[</span><span class="ss">:path</span><span class="p">]</span> <span class="o">==</span> <span class="vi">@path</span> <span class="p">}</span>
    <span class="k">return</span> <span class="n">status</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span> <span class="k">unless</span> <span class="n">match</span>

    <span class="n">body</span> <span class="n">match</span><span class="p">[</span><span class="ss">:block</span><span class="p">].</span><span class="nf">call</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="frankie-goes-top-level">Frankie goes top level</h2>

<p>New module <code class="highlighter-rouge">Frankie::Delegator</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre><span class="k">module</span> <span class="nn">Delegator</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">delegate</span><span class="p">(</span><span class="n">method_name</span><span class="p">)</span>
    <span class="n">define_method</span><span class="p">(</span><span class="n">method_name</span><span class="p">)</span> <span class="k">do</span> <span class="o">|*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="o">|</span>
      <span class="no">Application</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">method_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">delegate</span><span class="p">(</span><span class="ss">:get</span><span class="p">)</span>
  <span class="n">delegate</span><span class="p">(</span><span class="ss">:post</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>We also need (at the top level):</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="kp">extend</span> <span class="no">Frankie</span><span class="o">::</span><span class="no">Delegator</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>If we just did this, we could actually already run a ‘Hello world’ route. However, more work needs to be done. E.g., we want to be able to use the <code class="highlighter-rouge">params</code> method in our route blocks.</p>

<p>Change the <code class="highlighter-rouge">Application#route!</code> method to use <code class="highlighter-rouge">instance_eval</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">route!</span>
  <span class="n">match</span> <span class="o">=</span> <span class="no">Application</span><span class="p">.</span><span class="nf">routes</span>
                     <span class="p">.</span><span class="nf">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">route</span><span class="o">|</span> <span class="n">route</span><span class="p">[</span><span class="ss">:verb</span><span class="p">]</span> <span class="o">==</span> <span class="vi">@verb</span> <span class="p">}</span>
                     <span class="p">.</span><span class="nf">find</span>   <span class="p">{</span> <span class="o">|</span><span class="n">route</span><span class="o">|</span> <span class="n">route</span><span class="p">[</span><span class="ss">:path</span><span class="p">]</span> <span class="o">==</span> <span class="vi">@path</span> <span class="p">}</span>
  <span class="k">return</span> <span class="n">status</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span> <span class="k">unless</span> <span class="n">match</span>

  <span class="n">body</span> <span class="nb">instance_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">match</span><span class="p">[</span><span class="ss">:block</span><span class="p">])</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>And a <code class="highlighter-rouge">Templates</code> module:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13</pre></td><td class="code"><pre><span class="k">module</span> <span class="nn">Templates</span>
  <span class="k">def</span> <span class="nf">path_to_template</span><span class="p">(</span><span class="n">app_root</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
    <span class="n">template_dir</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="s1">'../views'</span><span class="p">,</span> <span class="n">app_root</span><span class="p">)</span>
    <span class="s2">"</span><span class="si">#{</span><span class="n">template_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">template</span><span class="si">}</span><span class="s2">.erb"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">erb</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="nb">binding</span>
    <span class="n">app_root</span> <span class="o">=</span> <span class="n">caller_locations</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">absolute_path</span>
    <span class="n">content</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">path_to_template</span><span class="p">(</span><span class="n">app_root</span><span class="p">,</span> <span class="n">template</span><span class="p">))</span>
    <span class="no">ERB</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">content</span><span class="p">).</span><span class="nf">result</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="frankie-recognizes-patterns">Frankie recognizes patterns</h2>

<p>Change the <code class="highlighter-rouge">route</code> class method, and add <code class="highlighter-rouge">compile</code> class method:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">Application</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">route</span><span class="p">(</span><span class="n">verb</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
      <span class="n">pattern</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="n">compile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

      <span class="n">routes</span> <span class="o">&lt;&lt;</span> <span class="p">{</span>
        <span class="ss">verb:     </span><span class="n">verb</span><span class="p">,</span>
        <span class="ss">pattern:  </span><span class="n">pattern</span><span class="p">,</span>
        <span class="ss">keys:     </span><span class="n">keys</span><span class="p">,</span>
        <span class="ss">block:    </span><span class="n">block</span>
      <span class="p">}</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
      <span class="n">segments</span> <span class="o">=</span> <span class="n">path</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>

      <span class="n">segments</span><span class="p">.</span><span class="nf">map!</span> <span class="k">do</span> <span class="o">|</span><span class="n">segment</span><span class="o">|</span>
        <span class="k">if</span> <span class="n">segment</span><span class="p">.</span><span class="nf">start_with?</span><span class="p">(</span><span class="s1">':'</span><span class="p">)</span>
          <span class="n">keys</span> <span class="o">&lt;&lt;</span> <span class="n">segment</span><span class="p">[</span><span class="mi">1</span><span class="p">.</span><span class="nf">.</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
          <span class="s2">"([^</span><span class="se">\/</span><span class="s2">]+)"</span>
        <span class="k">else</span>
          <span class="n">segment</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">pattern</span> <span class="o">=</span> <span class="no">Regexp</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">A</span><span class="si">#{</span><span class="n">segments</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span><span class="si">}</span><span class="se">\\</span><span class="s2">z"</span><span class="p">)</span>
      <span class="p">[</span><span class="n">pattern</span><span class="p">,</span> <span class="n">keys</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Change the <code class="highlighter-rouge">route!</code> instance method:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">Application</span>
  <span class="k">def</span> <span class="nf">route!</span>
    <span class="n">match</span> <span class="o">=</span> <span class="no">Application</span><span class="p">.</span><span class="nf">routes</span>
                       <span class="p">.</span><span class="nf">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">route</span><span class="o">|</span> <span class="n">route</span><span class="p">[</span><span class="ss">:verb</span><span class="p">]</span> <span class="o">==</span> <span class="vi">@verb</span> <span class="p">}</span>
                       <span class="p">.</span><span class="nf">find</span>   <span class="p">{</span> <span class="o">|</span><span class="n">route</span><span class="o">|</span> <span class="n">route</span><span class="p">[</span><span class="ss">:pattern</span><span class="p">].</span><span class="nf">match</span><span class="p">(</span><span class="vi">@path</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">return</span> <span class="n">status</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span> <span class="k">unless</span> <span class="n">match</span>

    <span class="c1"># CHANGE in 0.3: process captured groups</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">match</span><span class="p">[</span><span class="ss">:pattern</span><span class="p">].</span><span class="nf">match</span><span class="p">(</span><span class="vi">@path</span><span class="p">).</span><span class="nf">captures</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">merge!</span><span class="p">(</span><span class="n">match</span><span class="p">[</span><span class="ss">:keys</span><span class="p">].</span><span class="nf">zip</span><span class="p">(</span><span class="n">values</span><span class="p">).</span><span class="nf">to_h</span><span class="p">)</span>
    <span class="n">body</span><span class="p">(</span><span class="nb">instance_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">match</span><span class="p">[</span><span class="ss">:block</span><span class="p">]))</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="frankie-plays-catch">Frankie plays catch</h2>

<p>The <code class="highlighter-rouge">Application#call</code> method used to invoke the <code class="highlighter-rouge">Application#route!</code> method. It now reads <code class="highlighter-rouge">catch(:halt) { dispatch! }</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">Application</span>
  <span class="c1"># CHANGE: changed method in 0.4:</span>
  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="vi">@request</span>  <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="vi">@verb</span>     <span class="o">=</span> <span class="vi">@request</span><span class="p">.</span><span class="nf">request_method</span>
    <span class="vi">@path</span>     <span class="o">=</span> <span class="vi">@request</span><span class="p">.</span><span class="nf">path_info</span>

    <span class="vi">@response</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">status:  </span><span class="mi">200</span><span class="p">,</span>
      <span class="ss">headers: </span><span class="n">headers</span><span class="p">,</span>
      <span class="ss">body:    </span><span class="p">[]</span>
    <span class="p">}</span>

    <span class="c1"># CHANGE: changed line in 0.4:</span>
    <span class="kp">catch</span><span class="p">(</span><span class="ss">:halt</span><span class="p">)</span> <span class="p">{</span> <span class="n">dispatch!</span> <span class="p">}</span>

    <span class="vi">@response</span><span class="p">.</span><span class="nf">values</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Define <code class="highlighter-rouge">dispatch!</code>, change <code class="highlighter-rouge">route!</code>, define <code class="highlighter-rouge">not_found</code> and <code class="highlighter-rouge">redirect</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">Application</span>
  <span class="c1"># CHANGE: new method in 0.4</span>
  <span class="k">def</span> <span class="nf">dispatch!</span>
    <span class="n">route!</span>
    <span class="n">not_found</span>
  <span class="k">end</span>

  <span class="c1"># CHANGE in 0.4: handle not_found separately, use throw:</span>
  <span class="k">def</span> <span class="nf">route!</span>
    <span class="n">match</span> <span class="o">=</span> <span class="no">Application</span><span class="p">.</span><span class="nf">routes</span>
                       <span class="p">.</span><span class="nf">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">route</span><span class="o">|</span> <span class="n">route</span><span class="p">[</span><span class="ss">:verb</span><span class="p">]</span> <span class="o">==</span> <span class="vi">@verb</span> <span class="p">}</span>
                       <span class="p">.</span><span class="nf">find</span>   <span class="p">{</span> <span class="o">|</span><span class="n">route</span><span class="o">|</span> <span class="n">route</span><span class="p">[</span><span class="ss">:pattern</span><span class="p">].</span><span class="nf">match</span><span class="p">(</span><span class="vi">@path</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">return</span> <span class="k">unless</span> <span class="n">match</span>

    <span class="n">values</span> <span class="o">=</span> <span class="n">match</span><span class="p">[</span><span class="ss">:pattern</span><span class="p">].</span><span class="nf">match</span><span class="p">(</span><span class="vi">@path</span><span class="p">).</span><span class="nf">captures</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">merge!</span><span class="p">(</span><span class="n">match</span><span class="p">[</span><span class="ss">:keys</span><span class="p">].</span><span class="nf">zip</span><span class="p">(</span><span class="n">values</span><span class="p">).</span><span class="nf">to_h</span><span class="p">)</span>
    <span class="n">body</span><span class="p">(</span><span class="nb">instance_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">match</span><span class="p">[</span><span class="ss">:block</span><span class="p">]))</span>
    <span class="c1"># CHANGE in 0.4: new line</span>
    <span class="kp">throw</span> <span class="ss">:halt</span>
  <span class="k">end</span>

  <span class="c1"># CHANGE: new method in 0.4</span>
  <span class="k">def</span> <span class="nf">not_found</span>
    <span class="n">status</span> <span class="mi">404</span>
    <span class="n">body</span> <span class="s2">"&lt;h1&gt;404 Not Found&lt;/h1"</span>
    <span class="kp">throw</span> <span class="ss">:halt</span>
  <span class="k">end</span>

  <span class="c1"># CHANGE: new method in 0.4</span>
  <span class="k">def</span> <span class="nf">redirect</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
    <span class="n">status</span> <span class="p">(</span><span class="vi">@verb</span> <span class="o">==</span> <span class="s1">'GET'</span> <span class="p">?</span> <span class="mi">302</span> <span class="p">:</span> <span class="mi">303</span><span class="p">)</span>
    <span class="n">headers</span><span class="p">[</span><span class="s1">'Location'</span><span class="p">]</span> <span class="o">=</span> <span class="n">uri</span>
    <span class="kp">throw</span> <span class="ss">:halt</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="frankie-likes-cookies">Frankie likes cookies</h2>

<p>Setting up middleware</p>

<p>As an example, we will set up Frankie to use cookie-based session management as provided by <code class="highlighter-rouge">Rack::Session::Cookie</code> (which is also what Sinatra uses by default).</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">Application</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="c1"># CHANGE: changed method</span>
    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
      <span class="n">prototype</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="c1"># CHANGE: new method</span>
    <span class="k">def</span> <span class="nf">prototype</span>
      <span class="vi">@prototype</span> <span class="o">||=</span> <span class="kp">new</span>
    <span class="k">end</span>

    <span class="c1"># CHANGE: new alias</span>
    <span class="k">alias</span> <span class="kp">new</span><span class="o">!</span> <span class="kp">new</span>

    <span class="c1"># CHANGE: new/overridden method</span>
    <span class="k">def</span> <span class="nf">new</span>
      <span class="n">instance</span> <span class="o">=</span> <span class="kp">new</span><span class="o">!</span>
      <span class="n">build</span><span class="p">(</span><span class="n">instance</span><span class="p">).</span><span class="nf">to_app</span>
    <span class="k">end</span>

    <span class="c1"># CHANGE: new method</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
      <span class="n">builder</span> <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Builder</span><span class="p">.</span><span class="nf">new</span>

      <span class="k">if</span> <span class="vi">@middleware</span>
        <span class="vi">@middleware</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">middleware</span><span class="p">,</span> <span class="n">args</span><span class="o">|</span>
          <span class="n">builder</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="n">middleware</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">builder</span><span class="p">.</span><span class="nf">run</span> <span class="n">app</span>
      <span class="n">builder</span>
    <span class="k">end</span>

    <span class="c1"># CHANGE: new method</span>
    <span class="k">def</span> <span class="nf">use</span><span class="p">(</span><span class="n">middleware</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
      <span class="p">(</span><span class="vi">@middleware</span> <span class="o">||=</span> <span class="p">[])</span> <span class="o">&lt;&lt;</span> <span class="p">[</span><span class="n">middleware</span><span class="p">,</span> <span class="n">args</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Rename <code class="highlighter-rouge">call</code> method to <code class="highlighter-rouge">call!</code>, introduce new <code class="highlighter-rouge">call</code> method:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">Application</span>
  <span class="c1"># CHANGE: new method</span>
  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="nb">dup</span><span class="p">.</span><span class="nf">call!</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># CHANGE: this method used to be called `call`.</span>
  <span class="c1"># It is otherwise unchanged.</span>
  <span class="k">def</span> <span class="nf">call!</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="vi">@request</span>  <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="vi">@verb</span>     <span class="o">=</span> <span class="vi">@request</span><span class="p">.</span><span class="nf">request_method</span>
    <span class="vi">@path</span>     <span class="o">=</span> <span class="vi">@request</span><span class="p">.</span><span class="nf">path_info</span>

    <span class="vi">@response</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">status:  </span><span class="mi">200</span><span class="p">,</span>
      <span class="ss">headers: </span><span class="n">headers</span><span class="p">,</span>
      <span class="ss">body:    </span><span class="p">[]</span>
    <span class="p">}</span>

    <span class="kp">catch</span><span class="p">(</span><span class="ss">:halt</span><span class="p">)</span> <span class="p">{</span> <span class="n">dispatch!</span> <span class="p">}</span>

    <span class="vi">@response</span><span class="p">.</span><span class="nf">values</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>We also add a <code class="highlighter-rouge">session</code> method for accessing the session:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">Application</span>
  <span class="c1"># CHANGE: new method</span>
  <span class="k">def</span> <span class="nf">session</span>
    <span class="vi">@request</span><span class="p">.</span><span class="nf">session</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="frankie-returns">Frankie returns</h2>

<p>For flexible return values, we need to introduce one additional level of indirection. Within the <code class="highlighter-rouge">call!</code> method, we invoke <code class="highlighter-rouge">invoke</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">Application</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">call!</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
      <span class="vi">@request</span>  <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
      <span class="vi">@verb</span>     <span class="o">=</span> <span class="vi">@request</span><span class="p">.</span><span class="nf">request_method</span>
      <span class="vi">@path</span>     <span class="o">=</span> <span class="vi">@request</span><span class="p">.</span><span class="nf">path_info</span>

      <span class="vi">@response</span> <span class="o">=</span> <span class="p">{</span>
        <span class="ss">status:  </span><span class="mi">200</span><span class="p">,</span>
        <span class="ss">headers: </span><span class="n">headers</span><span class="p">,</span>
        <span class="ss">body:    </span><span class="p">[]</span>
      <span class="p">}</span>

      <span class="c1"># CHANGE: we use invoke now</span>
      <span class="n">invoke</span> <span class="p">{</span> <span class="n">dispatch!</span> <span class="p">}</span>

      <span class="vi">@response</span><span class="p">.</span><span class="nf">values</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><code class="highlighter-rouge">invoke</code> is defined as follows:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">Application</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">invoke</span>
      <span class="n">caught</span> <span class="o">=</span> <span class="kp">catch</span><span class="p">(</span><span class="ss">:halt</span><span class="p">)</span> <span class="p">{</span> <span class="k">yield</span> <span class="p">}</span>
      <span class="k">return</span> <span class="k">unless</span> <span class="n">caught</span>

      <span class="k">case</span> <span class="n">caught</span>
      <span class="k">when</span> <span class="no">Integer</span> <span class="k">then</span> <span class="n">status</span> <span class="n">caught</span>
      <span class="k">when</span> <span class="no">String</span> <span class="k">then</span> <span class="n">body</span> <span class="n">caught</span>
      <span class="k">else</span>
        <span class="n">body</span><span class="p">(</span><span class="o">*</span><span class="n">caught</span><span class="p">.</span><span class="nf">pop</span><span class="p">)</span>
        <span class="n">status</span> <span class="n">caught</span><span class="p">.</span><span class="nf">shift</span>
        <span class="n">headers</span><span class="p">.</span><span class="nf">merge!</span><span class="p">(</span><span class="o">*</span><span class="n">caught</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="finishing-touches">Finishing touches</h3>

<p>The code on github includes some additional minor changes.</p>

    </div>
  </div>

  <p class='terminal'>
    <small>&nbsp;</small>
  </p>
  <hr class="line" />
</section>

      <header>
  <p>
    <small>&nbsp;</small>
  </p>
  <a href="http://notes.benrodenhaeuser.io">
    <h1 class="title">
      Ben Rodenhäuser
    </h1>
  </a>

  <div class="description site-description">
    Notes on programming
  </div>

  <div class="content">
    <hr class="line" />

    <div class="sidebar-content">
      
      <h2 class="sidebar">
        <a class="post-link" href="/2018/03/11/understanding-sinatra/">Understanding Sinatra</a><span class="sidebar-pad"></span><small>11 Mar 2018</small>
      </h2>
      <p class="sidebar">
          Building a toy version of a popular Ruby framework from the ground up.
      </p>
      
      <h2 class="sidebar">
        <a class="post-link" href="/2017/12/18/a-bunch-of-sets/">A Bunch of Sets</a><span class="sidebar-pad"></span><small>18 Dec 2017</small>
      </h2>
      <p class="sidebar">
          A uniform implementation of classical sets, multisets and fuzzy sets, based on a generic set class.
      </p>
      
      <h2 class="sidebar">
        <a class="post-link" href="/2017/07/06/object-passing/">Passing Objects</a><span class="sidebar-pad"></span><small>06 Jul 2017</small>
      </h2>
      <p class="sidebar">
          Pass by reference or pass by value? Characterizing the object passing strategy followed by Ruby.
      </p>
      
      <h2 class="sidebar">
        <a class="post-link" href="/2017/05/15/sorting-in-ruby/">Sorting in Ruby</a><span class="sidebar-pad"></span><small>15 May 2017</small>
      </h2>
      <p class="sidebar">
          Why does Ruby have two sorting methods, rather than one?
      </p>
      
    </div>

    <hr class="line" />

    <div class="external">
      <a href="http://github.com/benrodenhaeuser">
        <img class="mark" src="/assets/images/GitHub-Mark-64px.png" />
      </a>
    </div>
  </div>
</header>

      <!-- <footer>
  <p><small>Ben Rodenhäuser 2017 | <a href="http://github.com/benrodenhaeuser">GitHub Profile</a></small></p>
</footer> -->

    </div>
    <script src="/assets/js/scale.fix.js"></script>
  </body>
</html>

